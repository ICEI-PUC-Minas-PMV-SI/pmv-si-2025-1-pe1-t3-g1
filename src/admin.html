<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="img/favicon-64x64.png">
    <link rel="apple-touch-icon" href="img/apple-touch-icon.png">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/storage.js" defer></script>
    <script src="js/auth.js" defer></script>
    <title>Administração - Monitoria de PAN</title>
    <style>
        .material-icons {
            font-size: 20px;
            vertical-align: middle;
        }
        .filter-dropdown {
            position: relative;
            display: inline-block;
        }
        .filter-dropdown select {
            appearance: none;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding-left: 2.5rem;
            padding-right: 2rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 180px;
        }
        .filter-dropdown select:hover {
            border-color: var(--color-primary);
        }
        .filter-dropdown select:focus {
            outline: none;
            --tw-ring-offset-shadow: 0 0 #0000;
            --tw-ring-shadow: 0 0 0 2px var(--color-primary);
            --tw-shadow: 0 0 #0000;
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow);
            border-color: transparent;
        }
        .filter-dropdown .material-icons {
            position: absolute;
            left: 0.75rem;
            top: 0.625rem;
            color: #9ca3af;
            pointer-events: none;
        }
        .filter-dropdown::after {
            content: '';
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid #9ca3af;
            pointer-events: none;
        }
        
        /* Estilo para os inputs do formulário */
        input[type="text"],
        input[type="email"],
        input[type="password"],
        select {
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }
        
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus,
        select:focus {
            --tw-ring-offset-shadow: 0 0 #0000;
            --tw-ring-shadow: 0 0 #0000;
            --tw-shadow: 0 0 0 2px var(--color-primary);
            box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
            border-color: transparent;
        }

        /* Estilo para os labels do formulário */
        label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
            display: block;
        }

        /* Estilo para os cards de estatísticas */
        .monitoring-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-left-width: 4px;
            transition: box-shadow 0.2s;
        }

        .monitoring-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Estilo para o sidenav */
        .form-field-outline {
            position: relative;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
        }

        .form-field-outline:focus-within {
            border-color: var(--color-primary);
        }

        .form-field-outline:focus-within label {
            color: var(--color-primary);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="layout-content">

    </div>

    <div id="page-content" class="hidden">
        <div class="p-4 md:p-6 min-h-screen">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6">
                <div class="bg-white p-4 md:p-6 rounded-lg shadow-md border-l-4 border-[var(--color-primary)] hover:shadow-lg transition-shadow">
                    <div class="flex items-center space-x-3">
                        <span class="material-icons text-[var(--color-primary)]">group</span>
                        <h3 class="text-base md:text-lg font-semibold text-gray-600">Total de Usuários</h3>
                    </div>
                    <p class="text-2xl md:text-3xl font-bold text-dark mt-2" id="total-users">0</p>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-lg shadow-md border-l-4 border-green-500 hover:shadow-lg transition-shadow">
                    <div class="flex items-center space-x-3">
                        <span class="material-icons text-green-500">check_circle</span>
                        <h3 class="text-base md:text-lg font-semibold text-gray-600">Usuários Ativos</h3>
                    </div>
                    <p class="text-2xl md:text-3xl font-bold text-green-600 mt-2" id="active-users">0</p>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-lg shadow-md border-l-4 border-red-500 hover:shadow-lg transition-shadow">
                    <div class="flex items-center space-x-3">
                        <span class="material-icons text-red-500">cancel</span>
                        <h3 class="text-base md:text-lg font-semibold text-gray-600">Usuários Inativos</h3>
                    </div>
                    <p class="text-2xl md:text-3xl font-bold text-red-600 mt-2" id="inactive-users">0</p>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-lg shadow-md border-l-4 border-accent hover:shadow-lg transition-shadow">
                    <div class="flex items-center space-x-3">
                        <span class="material-icons text-accent">admin_panel_settings</span>
                        <h3 class="text-base md:text-lg font-semibold text-gray-600">Administradores</h3>
                    </div>
                    <p class="text-2xl md:text-3xl font-bold text-accent mt-2" id="admin-users">0</p>
                </div>
            </div>

            <div class="bg-white p-4 md:p-6 rounded-xl shadow-md">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center space-y-4 lg:space-y-0 mb-6">
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold text-dark flex items-center">
                            <span class="material-icons mr-2 text-[var(--color-primary)]">manage_accounts</span>
                            Gerenciamento de Usuários
                        </h1>
                        <p class="text-sm md:text-base text-gray-600 mt-1">Gerencie todos os usuários do sistema</p>
                    </div>
                    <div class="flex items-center gap-3 w-full lg:w-auto">
                        <div class="relative flex-1 lg:flex-none">
                            <div class="relative flex items-center">
                                <span class="material-icons absolute left-3 text-gray-400">search</span>
                            <input type="text" 
                                   id="search-users" 
                                   placeholder="Buscar usuários..."
                                       class="w-full lg:w-80 pl-10 pr-4 h-10 bg-white border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)] focus:border-transparent">
                            </div>
                        </div>
                        <button onclick="toggleFilterSidenav()" 
                                class="flex-shrink-0 flex items-center justify-center w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-all duration-200 shadow-sm hover:shadow-md">
                            <span class="material-icons">filter_list</span>
                        </button>
                        <button onclick="openUserModal()" 
                                class="flex-shrink-0 flex items-center justify-center w-10 h-10 rounded-full bg-[var(--color-primary)] hover:bg-[var(--color-dark-green)] text-white transition-all duration-200 shadow-sm hover:shadow-md">
                            <span class="material-icons">add</span>
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto bg-white rounded-xl shadow-sm border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 md:px-6 py-3 text-left text-xs md:text-sm font-semibold text-gray-600 uppercase tracking-wider">
                                    <div class="flex items-center space-x-2">
                                        <span class="material-icons text-gray-400 text-base">person</span>
                                        <span>Nome</span>
                                    </div>
                                </th>
                                <th class="px-4 md:px-6 py-3 text-left text-xs md:text-sm font-semibold text-gray-600 uppercase tracking-wider">
                                    <div class="flex items-center space-x-2">
                                        <span class="material-icons text-gray-400 text-base">email</span>
                                        <span>Email</span>
                                    </div>
                                </th>
                                <th class="px-4 md:px-6 py-3 text-left text-xs md:text-sm font-semibold text-gray-600 uppercase tracking-wider">
                                    <div class="flex items-center space-x-2">
                                        <span class="material-icons text-gray-400 text-base">badge</span>
                                        <span>Papel</span>
                                    </div>
                                </th>
                                <th class="px-4 md:px-6 py-3 text-left text-xs md:text-sm font-semibold text-gray-600 uppercase tracking-wider">
                                    <div class="flex items-center space-x-2">
                                        <span class="material-icons text-gray-400 text-base">radio_button_checked</span>
                                        <span>Status</span>
                                    </div>
                                </th>
                                <th class="px-4 md:px-6 py-3 text-left text-xs md:text-sm font-semibold text-gray-600 uppercase tracking-wider">
                                    <div class="flex items-center space-x-2">
                                        <span class="material-icons text-gray-400 text-base">settings</span>
                                        <span>Ações</span>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="divide-y divide-gray-100">
                        </tbody>
                    </table>
                    <div id="no-results" class="hidden py-12">
                        <div class="text-center">
                            <span class="material-icons text-gray-400 text-5xl mb-2">search_off</span>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">Nenhum usuário encontrado</h3>
                            <p class="mt-1 text-sm text-gray-500">Não foram encontrados usuários com os filtros aplicados.</p>
                            <div class="mt-6">
                                <button onclick="limparFiltros()" 
                                        class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-[var(--color-primary)] hover:bg-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--color-primary)] transition-all duration-200">
                                    <span class="material-icons mr-2">refresh</span>
                                    Limpar Filtros
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="user-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-4 md:p-8 border w-[95%] max-w-4xl shadow-lg rounded-xl bg-white">
            <div class="absolute top-4 right-4">
                <button onclick="closeUserModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div>
                <h3 class="text-xl md:text-2xl font-bold text-dark mb-6 flex items-center" id="modal-title">
                    <span class="material-icons mr-2 text-[var(--color-primary)]">person_add</span>
                    Novo Usuário
                </h3>
                <form id="user-form" class="space-y-6">
                    <input type="hidden" id="user-email-original">
                    <div class="grid grid-cols-1 gap-6">
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <label for="user-name" class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                            <div class="relative">
                                <span class="material-icons absolute left-3 top-2.5 text-gray-400">person</span>
                            <input type="text" id="user-name" required
                                       class="w-full pl-10 pr-4 py-2 bg-white rounded-xl border border-gray-300 focus:border-[var(--color-primary)] focus:ring focus:ring-[var(--color-primary)] focus:ring-opacity-50 transition-all duration-200">
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <label for="user-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <div class="relative">
                                <span class="material-icons absolute left-3 top-2.5 text-gray-400">email</span>
                            <input type="email" id="user-email" required
                                       class="w-full pl-10 pr-4 py-2 bg-white rounded-xl border border-gray-300 focus:border-[var(--color-primary)] focus:ring focus:ring-[var(--color-primary)] focus:ring-opacity-50 transition-all duration-200">
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <label for="user-password" class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                            <div class="relative">
                                <span class="material-icons absolute left-3 top-2.5 text-gray-400">lock</span>
                                <input type="password" id="user-password" required minlength="8"
                                       class="w-full pl-10 pr-4 py-2 bg-white rounded-xl border border-gray-300 focus:border-[var(--color-primary)] focus:ring focus:ring-[var(--color-primary)] focus:ring-opacity-50 transition-all duration-200">
                    </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <label for="user-role" class="block text-sm font-medium text-gray-700 mb-2">Papel</label>
                            <div class="relative">
                                <span class="material-icons absolute left-3 top-2.5 text-gray-400">badge</span>
                            <select id="user-role" required
                                        class="w-full pl-10 pr-4 py-2 bg-white rounded-xl border border-gray-300 focus:border-[var(--color-primary)] focus:ring focus:ring-[var(--color-primary)] focus:ring-opacity-50 transition-all duration-200 appearance-none">
                                <option value="admin">Administrador</option>
                                <option value="coordenador">Coordenador</option>
                                    <option value="articulador">Articulador</option>
                                    <option value="colaborador">Colaborador</option>
                            </select>
                                <span class="absolute right-3 top-2.5 text-gray-400 material-icons pointer-events-none">expand_more</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4 mt-8">
                        <button type="button" onclick="closeUserModal()"
                                class="flex items-center px-4 py-2 border border-gray-300 rounded-xl text-gray-700 bg-white hover:bg-gray-50 transition-all duration-200">
                            <span class="material-icons mr-1 text-base">close</span>
                            Cancelar
                        </button>
                        <button type="submit"
                                class="flex items-center px-4 py-2 bg-[var(--color-primary)] hover:bg-[var(--color-dark-green)] text-white rounded-xl transition-all duration-200 hover:shadow-lg">
                            <span class="material-icons mr-1 text-base">save</span>
                            Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="history-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-4 md:p-8 border w-[95%] max-w-4xl shadow-lg rounded-xl bg-white">
            <div class="absolute top-4 right-4">
                <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div>
                <h3 class="text-xl md:text-2xl font-bold text-dark mb-6 flex items-center">
                    <span class="material-icons mr-2 text-[var(--color-primary)]">history</span>
                    Histórico de Alterações
                </h3>
                <div class="mb-4">
                    <div class="relative">
                        <span class="material-icons absolute left-3 top-2.5 text-gray-400">search</span>
                    <input type="text" 
                               id="history-search" 
                           placeholder="Buscar no histórico..."
                               class="w-full pl-10 pr-4 py-2 bg-white border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)] focus:border-transparent">
                </div>
                </div>
                <div id="history-content" class="space-y-4 max-h-[60vh] overflow-y-auto">
                    <!-- O conteúdo do histórico será inserido aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Sidenav de Filtros -->
    <div id="filter-sidenav" class="fixed right-0 top-0 h-full w-full md:w-80 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50 overflow-y-auto">
        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between p-4 border-b">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <span class="material-icons mr-2">filter_list</span>
                    Filtros
                </h3>
                <button onclick="toggleFilterSidenav()" class="text-gray-500 hover:text-gray-700">
                    <span class="material-icons">close</span>
                </button>
            </div>
            
            <div class="p-4 flex-1 overflow-y-auto">
                <div class="space-y-6">
                    <div class="form-field">
                        <label class="text-sm font-medium text-gray-700 mb-2 block">Status</label>
                        <div class="relative">
                            <div class="form-field-outline">
                                <select id="filter-status" class="w-full h-14 px-4 pt-4 pb-1 border border-gray-300 rounded-lg bg-transparent peer focus:outline-none focus:border-[var(--color-primary)] focus:ring-0 appearance-none">
                                    <option value="">Todos</option>
                                    <option value="ativo">Ativo</option>
                                    <option value="inativo">Inativo</option>
                                </select>
                                <label class="absolute left-4 top-4 text-gray-500 text-sm transition-all peer-focus:text-xs peer-focus:top-1.5 peer-focus:text-[var(--color-primary)] peer-[:not(:placeholder-shown)]:text-xs peer-[:not(:placeholder-shown)]:top-1.5">
                                    Status
                                </label>
                                <span class="material-icons absolute right-4 top-4 text-gray-400 pointer-events-none">
                                    expand_more
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="form-field">
                        <label class="text-sm font-medium text-gray-700 mb-2 block">Papel</label>
                        <div class="relative">
                            <div class="form-field-outline">
                                <select id="filter-papel" class="w-full h-14 px-4 pt-4 pb-1 border border-gray-300 rounded-lg bg-transparent peer focus:outline-none focus:border-[var(--color-primary)] focus:ring-0 appearance-none">
                                    <option value="">Todos</option>
                                    <option value="admin">Administrador</option>
                                    <option value="coordenador">Coordenador</option>
                                    <option value="articulador">Articulador</option>
                                    <option value="colaborador">Colaborador</option>
                                </select>
                                <label class="absolute left-4 top-4 text-gray-500 text-sm transition-all peer-focus:text-xs peer-focus:top-1.5 peer-focus:text-[var(--color-primary)] peer-[:not(:placeholder-shown)]:text-xs peer-[:not(:placeholder-shown)]:top-1.5">
                                    Papel
                                </label>
                                <span class="material-icons absolute right-4 top-4 text-gray-400 pointer-events-none">
                                    expand_more
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t">
                <button onclick="aplicarFiltros()" 
                        class="w-full flex items-center justify-center px-4 py-2 bg-[var(--color-primary)] hover:bg-[var(--color-dark-green)] text-white rounded-xl transition-all duration-200">
                    <span class="material-icons mr-2">check</span>
                    Aplicar Filtros
                </button>
            </div>
        </div>
    </div>

    <!-- Overlay do Sidenav -->
    <div id="sidenav-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40" onclick="toggleFilterSidenav()"></div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            if (!isLoggedIn()) {
                window.location.href = 'login.html';
                return;
            }

            const user = getCurrentUser();
            if (user.papel !== 'admin') {
                window.location.href = 'index.html';
                return;
            }

            try {
                const response = await fetch('layout.html');
                const html = await response.text();
                document.getElementById('layout-content').innerHTML = html;
                const pageContent = document.getElementById('page-content');
                const layoutContent = document.getElementById('content');
                if (layoutContent) {
                    layoutContent.innerHTML = pageContent.innerHTML;
                }
                pageContent.remove();
                await loadUsers();

                document.getElementById('search-users').addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('#users-table-body tr');
                    
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
            } catch (error) {
                console.error('Erro ao carregar a página:', error);
            }
        });

        function openUserModal(user = null) {
            const modal = document.getElementById('user-modal');
            const form = document.getElementById('user-form');
            const title = document.getElementById('modal-title');
            const emailInput = document.getElementById('user-email');
            const emailOriginal = document.getElementById('user-email-original');
            
            title.textContent = user ? 'Editar Usuário' : 'Novo Usuário';
            
            if (user) {
                document.getElementById('user-name').value = user.nome;
                emailInput.value = user.email;
                emailInput.readOnly = true;
                emailOriginal.value = user.email;
                document.getElementById('user-role').value = user.papel;
                document.getElementById('user-password').required = false;
                document.getElementById('user-password').placeholder = 'Deixe em branco para manter a senha atual';
            } else {
                form.reset();
                emailInput.readOnly = false;
                emailOriginal.value = '';
                document.getElementById('user-password').required = true;
                document.getElementById('user-password').placeholder = '';
            }
            
            modal.classList.remove('hidden');
        }

        function closeUserModal() {
            document.getElementById('user-modal').classList.add('hidden');
        }
        
        function openHistoryModal(user) {
            const modal = document.getElementById('history-modal');
            const content = document.getElementById('history-content');
            const searchInput = document.getElementById('history-search');
            const noResults = document.getElementById('no-history-results');

            searchInput.value = '';
            
            if (!user.historico || user.historico.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-500">Nenhum histórico disponível para este usuário.</p>
                    </div>`;
                noResults.classList.add('hidden');
                content.classList.remove('hidden');
            } else {
                renderHistorico(user.historico);

                searchInput.onkeyup = () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    const filteredHistory = user.historico.filter(entry => 
                        entry.acao.toLowerCase().includes(searchTerm) ||
                        entry.por.toLowerCase().includes(searchTerm) ||
                        entry.data.toLowerCase().includes(searchTerm) ||
                        (entry.alteracoes && entry.alteracoes.toLowerCase().includes(searchTerm))
                    );
                    
                    if (filteredHistory.length === 0) {
                        content.classList.add('hidden');
                        noResults.classList.remove('hidden');
                    } else {
                        renderHistorico(filteredHistory);
                        content.classList.remove('hidden');
                        noResults.classList.add('hidden');
                    }
                };
            }
            
            modal.classList.remove('hidden');
        }

        function renderHistorico(historico) {
            const content = document.getElementById('history-content');
            
            content.innerHTML = historico.map(entry => `
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="material-icons text-[var(--color-primary)]">event</span>
                        <span class="text-sm font-medium text-[var(--color-primary)]">${entry.data}</span>
                        </div>
                        <div class="flex items-center space-x-2 text-sm text-gray-600">
                            <span class="material-icons text-gray-400">person</span>
                            <span>${entry.por}</span>
                        </div>
                    </div>
                    <div class="flex items-start space-x-2">
                        <span class="material-icons text-gray-400 mt-0.5">info</span>
                        <div>
                    <div class="text-gray-900">${entry.acao}</div>
                    ${entry.alteracoes ? `
                        <div class="mt-2 text-sm text-gray-600">
                                    <span class="font-medium flex items-center space-x-1">
                                        <span class="material-icons text-gray-400 text-base">edit_note</span>
                                        <span>Alterações:</span>
                                    </span>
                                    <div class="mt-1 ml-6">${entry.alteracoes}</div>
                        </div>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function closeHistoryModal() {
            document.getElementById('history-modal').classList.add('hidden');
            document.getElementById('history-search').value = '';
            document.getElementById('no-history-results').classList.add('hidden');
            document.getElementById('history-content').classList.remove('hidden');
        }

        function updateStats(users) {
            document.getElementById('total-users').textContent = users.length;
            document.getElementById('active-users').textContent = users.filter(u => u.status === 'ativo').length;
            document.getElementById('inactive-users').textContent = users.filter(u => u.status === 'inativo').length;
            document.getElementById('admin-users').textContent = users.filter(u => u.papel === 'admin').length;
        }
        
        function limparFiltros() {
            document.getElementById('search-users').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-papel').value = '';
            filtrarUsuarios();
        }

        function filtrarUsuarios() {
            const searchTerm = document.getElementById('search-users').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            const papelFilter = document.getElementById('filter-papel').value;
            const rows = document.querySelectorAll('#users-table-body tr');
            const table = document.querySelector('table');
            const noResults = document.getElementById('no-results');
            
            let visibleCount = 0;
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const status = row.querySelector('[data-status]')?.dataset.status;
                const papel = row.querySelector('[data-papel]')?.dataset.papel;
                
                const matchSearch = text.includes(searchTerm);
                const matchStatus = !statusFilter || status === statusFilter;
                const matchPapel = !papelFilter || papel === papelFilter;
                
                const isVisible = matchSearch && matchStatus && matchPapel;
                row.style.display = isVisible ? '' : 'none';
                
                if (isVisible) visibleCount++;
            });

            if (visibleCount === 0) {
                table.classList.add('hidden');
                noResults.classList.remove('hidden');
            } else {
                table.classList.remove('hidden');
                noResults.classList.add('hidden');
            }
        }

        async function loadUsers() {
            const usuarios = await listarUsuarios();
            const tbody = document.getElementById('users-table-body');
            
            updateStats(usuarios);
            
            tbody.innerHTML = usuarios.map(usuario => {
                const primeiraLetra = usuario.nome ? usuario.nome.charAt(0).toUpperCase() : '?';
                const statusClasses = usuario.status === 'ativo' 
                    ? 'bg-green-100 text-green-800 border border-green-200' 
                    : 'bg-red-100 text-red-800 border border-red-200';
                
                return `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 md:px-6 py-3 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="h-10 w-10 flex-shrink-0 mr-3">
                                <div class="h-10 w-10 rounded-full bg-gradient-to-br from-[var(--color-primary)] to-dark flex items-center justify-center shadow-sm">
                                    <span class="text-white font-medium text-lg">${primeiraLetra}</span>
                                </div>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900">${usuario.nome || 'Sem nome'}</div>
                                <div class="text-sm text-gray-500" data-papel="${usuario.papel}">${getNomePapel(usuario.papel)}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 md:px-6 py-3 whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                            <span class="material-icons text-gray-400 text-base">email</span>
                        <div class="text-sm text-gray-900">${usuario.email}</div>
                        </div>
                    </td>
                    <td class="px-4 md:px-6 py-3 whitespace-nowrap">
                        <span class="px-3 py-1.5 inline-flex items-center text-xs leading-5 font-semibold rounded-full shadow-sm
                                   ${getCorPapel(usuario.papel)}" data-papel="${usuario.papel}">
                            <span class="material-icons text-base mr-1">${getIconePapel(usuario.papel)}</span>
                            ${getNomePapel(usuario.papel)}
                        </span>
                    </td>
                    <td class="px-4 md:px-6 py-3 whitespace-nowrap">
                        <span class="px-3 py-1.5 inline-flex items-center text-xs leading-5 font-semibold rounded-full shadow-sm
                                   ${statusClasses}"
                                  data-status="${usuario.status}">
                            <span class="material-icons text-base mr-1">${usuario.status === 'ativo' ? 'check_circle' : 'cancel'}</span>
                            ${usuario.status === 'ativo' ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                    <td class="px-4 md:px-6 py-3 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-3">
                            ${usuario.email === 'master@icmbio.com' ? `
                                <button onclick='openHistoryModal(${JSON.stringify(usuario).replace(/'/g, "&#39;")})'
                                        class="inline-flex items-center text-gray-600 hover:text-gray-900 transition-colors">
                                    <span class="material-icons text-base mr-1">history</span>
                                    <span>Histórico</span>
                                </button>
                            ` : `
                                <button onclick='openUserModal(${JSON.stringify(usuario).replace(/'/g, "&#39;")})'
                                        class="inline-flex items-center text-[var(--color-primary)] hover:text-dark transition-colors">
                                    <span class="material-icons text-base mr-1">edit</span>
                                    <span>Editar</span>
                                </button>
                                <button onclick='alternarStatusUsuario("${usuario.email}")'
                                        class="inline-flex items-center text-${usuario.status === 'ativo' ? 'red' : 'green'}-600 
                                               hover:text-${usuario.status === 'ativo' ? 'red' : 'green'}-900 transition-colors">
                                    <span class="material-icons text-base mr-1">${usuario.status === 'ativo' ? 'block' : 'check_circle'}</span>
                                    <span>${usuario.status === 'ativo' ? 'Inativar' : 'Ativar'}</span>
                                </button>
                                <button onclick='openHistoryModal(${JSON.stringify(usuario).replace(/'/g, "&#39;")})'
                                        class="inline-flex items-center text-gray-600 hover:text-gray-900 transition-colors">
                                    <span class="material-icons text-base mr-1">history</span>
                                    <span>Histórico</span>
                                </button>
                            `}
                        </div>
                    </td>
                </tr>
            `}).join('');

            document.getElementById('search-users').addEventListener('input', filtrarUsuarios);
            document.getElementById('filter-status').addEventListener('change', filtrarUsuarios);
            document.getElementById('filter-papel').addEventListener('change', filtrarUsuarios);
        }

        function getNomePapel(papel) {
            const papeis = {
                admin: 'Administrador',
                coordenador: 'Coordenador',
                articulador: 'Articulador',
                colaborador: 'Colaborador'
            };
            return papeis[papel] || papel;
        }

        function getCorPapel(papel) {
            const cores = {
                admin: 'bg-violet-100 text-violet-800 border border-violet-200',
                coordenador: 'bg-blue-100 text-blue-800 border border-blue-200',
                articulador: 'bg-amber-100 text-amber-800 border border-amber-200',
                colaborador: 'bg-emerald-100 text-emerald-800 border border-emerald-200'
            };
            return cores[papel] || 'bg-gray-100 text-gray-800 border border-gray-200';
        }

        function getIconePapel(papel) {
            const icones = {
                admin: 'admin_panel_settings',
                coordenador: 'supervisor_account',
                articulador: 'hub',
                colaborador: 'person'
            };
            return icones[papel] || 'person';
        }

        async function alternarStatusUsuario(email) {
            const resultado = await alternarStatus(email);
            if (resultado.sucesso) {
                loadUsers();
            } else {
                alert(resultado.mensagem);
            }
        }

        document.getElementById('user-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const emailOriginal = document.getElementById('user-email-original').value;
            const dados = {
                nome: document.getElementById('user-name').value,
                email: document.getElementById('user-email').value,
                senha: document.getElementById('user-password').value,
                papel: document.getElementById('user-role').value
            };
            
            let resultado;
            if (emailOriginal) {
                resultado = await editarUsuario(emailOriginal, {
                    nome: dados.nome,
                    papel: dados.papel,
                    ...(dados.senha && { senha: dados.senha })
                });
            } else {
                resultado = await registrarUsuario(dados.email, dados.senha, dados.nome, dados.papel);
            }
            
            if (resultado.sucesso) {
                closeUserModal();
                loadUsers();
            } else {
                alert(resultado.mensagem);
            }
        });

        function toggleFilterSidenav() {
            const sidenav = document.getElementById('filter-sidenav');
            const overlay = document.getElementById('sidenav-overlay');
            
            if (sidenav.classList.contains('translate-x-full')) {
                sidenav.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            } else {
                sidenav.classList.add('translate-x-full');
                overlay.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }
        }

        function aplicarFiltros() {
            toggleFilterSidenav();
            filtrarUsuarios();
        }
    </script>
</body>
</html> 